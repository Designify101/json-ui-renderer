# CSS Extraction Guide

This guide covers the CSS class extraction system that ensures all Tailwind classes used in JSON templates are included in the final build, preventing missing styles in production.

## Table of Contents

1. [Overview](#overview)
2. [Extraction Process](#extraction-process)
3. [Build Integration](#build-integration)
4. [Supported Patterns](#supported-patterns)
5. [Configuration](#configuration)
6. [Troubleshooting](#troubleshooting)

## Overview

The CSS extraction system (`scripts/extract-template-classes.js`) solves the problem of Tailwind CSS not detecting classes used in JSON templates, ensuring all dynamic styles are included in production builds.

### Problem Statement

Tailwind CSS uses static analysis to detect which classes are used in your code. However, classes defined in JSON templates are not automatically detected, leading to missing styles in production builds.

### Solution

The extraction script:
1. Scans all template files for CSS classes
2. Extracts classes from JSON configurations
3. Generates a file that Tailwind can scan
4. Ensures all classes are included in builds

## Extraction Process

### Script Architecture

```javascript
// scripts/extract-template-classes.js
const fs = require('fs');
const path = require('path');

// Configuration
const TEMPLATES_DIR = path.join(__dirname, '../lib');
const OUTPUT_FILE = path.join(__dirname, '../generated/template-classes.js');

// CSS class patterns to match
const CSS_CLASS_PATTERNS = [
  /className:\s*"([^"]+)"/g,        // TypeScript object notation
  /"className"\s*:\s*"([^"]+)"/g,   // JSON format
  /"class"\s*:\s*"([^"]+)"/g,       // Alternative class attr
  /className:\s*`([^`]+)`/g,        // Template literals
  /className:\s*'([^']+)'/g         // Single quotes
];
```

### Extraction Logic

```javascript
function extractClassesFromContent(content) {
  CSS_CLASS_PATTERNS.forEach(pattern => {
    let match;
    pattern.lastIndex = 0; // Reset regex for global patterns
    
    while ((match = pattern.exec(content)) !== null) {
      const classNames = match[1];
      
      // Split by spaces and filter
      classNames.split(/\s+/).forEach(className => {
        const trimmed = className.trim();
        if (trimmed && !trimmed.includes('{{') && !trimmed.includes('$')) {
          // Only add valid CSS classes, exclude template variables
          extractedClasses.add(trimmed);
        }
      });
    }
  });
}
```

### File Scanning

```javascript
function scanDirectory(dirPath) {
  const items = fs.readdirSync(dirPath);
  
  items.forEach(item => {
    const itemPath = path.join(dirPath, item);
    const stat = fs.statSync(itemPath);
    
    if (stat.isDirectory()) {
      scanDirectory(itemPath); // Recursive scanning
    } else if (item.endsWith('.ts') || item.endsWith('.js')) {
      extractClassesFromFile(itemPath);
    }
  });
}
```

## Build Integration

### Package.json Scripts

```json
{
  "scripts": {
    "extract-classes": "node scripts/extract-template-classes.js",
    "build": "npm run extract-classes && next build",
    "dev": "npm run extract-classes && next dev"
  }
}
```

### Tailwind Configuration

```javascript
// tailwind.config.ts
module.exports = {
  content: [
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./generated/template-classes.js", // Include generated file
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
```

### Generated Output

```javascript
// generated/template-classes.js
/**
 * Generated file containing all CSS classes used in JSON templates
 * This file is automatically generated by scripts/extract-template-classes.js
 * DO NOT EDIT MANUALLY - your changes will be overwritten
 * 
 * Generated at: 2024-01-15T10:30:00.000Z
 * Total classes: 847
 */

// These CSS classes are used in JSON templates
export const templateClasses = [
  "absolute",
  "bg-background",
  "bg-card",
  "bg-white",
  "border",
  "border-border",
  "border-gray-200",
  "flex",
  "flex-col",
  "font-bold",
  "gap-4",
  "grid",
  "grid-cols-1",
  "grid-cols-2",
  "grid-cols-3",
  "h-4",
  "h-full",
  "max-w-md",
  "p-4",
  "p-6",
  "rounded",
  "rounded-lg",
  "space-y-4",
  "text-center",
  "text-foreground",
  "text-lg",
  "text-sm",
  "w-4",
  "w-full",
  // ... more classes
];

// Export classes as a string for Tailwind content scanning
export const templateClassesString = `
absolute bg-background bg-card bg-white border border-border border-gray-200 flex flex-col font-bold gap-4 grid grid-cols-1 grid-cols-2 grid-cols-3 h-4 h-full max-w-md p-4 p-6 rounded rounded-lg space-y-4 text-center text-foreground text-lg text-sm w-4 w-full
`;

// Default export for convenience
export default templateClasses;
```

## Supported Patterns

### TypeScript Object Notation

```typescript
// Detected patterns
const template = {
  type: "Card",
  props: {
    className: "p-4 bg-white rounded-lg shadow-md"
  }
}
```

### JSON Format

```json
{
  "type": "Card",
  "props": {
    "className": "p-4 bg-white rounded-lg shadow-md"
  }
}
```

### Alternative Formats

```typescript
// Template literals
className: `p-4 ${isDark ? 'bg-gray-900' : 'bg-white'}`

// Single quotes
className: 'p-4 bg-white rounded-lg'

// Class attribute
"class": "p-4 bg-white rounded-lg"
```

### Filtering Logic

```javascript
// Classes that are excluded from extraction
const excludedPatterns = [
  /\{\{.*\}\}/,    // Template variables: {{className}}
  /\$\w+/,         // Variable references: $primary
  /^\s*$/,         // Empty strings
  /[<>]/,          // Invalid characters
];
```

## Configuration

### Script Configuration

```javascript
// scripts/extract-template-classes.js
const CONFIG = {
  // Source directories to scan
  TEMPLATES_DIR: path.join(__dirname, '../lib'),
  COMPONENTS_DIR: path.join(__dirname, '../components'),
  
  // Output configuration
  OUTPUT_FILE: path.join(__dirname, '../generated/template-classes.js'),
  GENERATED_DIR: path.join(__dirname, '../generated'),
  
  // File patterns to scan
  FILE_PATTERNS: ['.ts', '.js', '.json'],
  
  // Class extraction patterns
  CSS_CLASS_PATTERNS: [
    /className:\s*"([^"]+)"/g,
    /"className"\s*:\s*"([^"]+)"/g,
    /"class"\s*:\s*"([^"]+)"/g,
  ]
};
```

### Custom Patterns

```javascript
// Add custom extraction patterns
const CUSTOM_PATTERNS = [
  // Custom attribute patterns
  /customClass:\s*"([^"]+)"/g,
  /styleClass:\s*"([^"]+)"/g,
  
  // Framework-specific patterns
  /tw-class:\s*"([^"]+)"/g,
  /tailwind:\s*"([^"]+)"/g,
];

// Combine with default patterns
const ALL_PATTERNS = [...CSS_CLASS_PATTERNS, ...CUSTOM_PATTERNS];
```

### Directory Configuration

```javascript
// Scan multiple directories
const SCAN_DIRECTORIES = [
  path.join(__dirname, '../lib'),           // Templates
  path.join(__dirname, '../components'),    // Components
  path.join(__dirname, '../app'),           // App files
  path.join(__dirname, '../data'),          // Data files
];
```

## Troubleshooting

### Missing Classes

**Problem**: Classes not appearing in production build

**Solution**: 
1. Check if classes are properly extracted:
   ```bash
   npm run extract-classes
   cat generated/template-classes.js | grep "your-class"
   ```

2. Verify Tailwind configuration includes generated file:
   ```javascript
   // tailwind.config.ts
   content: [
     "./generated/template-classes.js", // Make sure this is included
   ]
   ```

### Script Errors

**Problem**: Extraction script fails

**Solution**:
1. Check file permissions:
   ```bash
   chmod +x scripts/extract-template-classes.js
   ```

2. Verify Node.js version (requires Node 14+):
   ```bash
   node --version
   ```

3. Check for syntax errors in template files:
   ```bash
   npm run extract-classes --verbose
   ```

### Build Integration Issues

**Problem**: Classes not extracted during build

**Solution**:
1. Ensure script runs before build:
   ```json
   {
     "scripts": {
       "prebuild": "npm run extract-classes",
       "build": "next build"
     }
   }
   ```

2. Check generated directory exists:
   ```bash
   mkdir -p generated
   ```

### Performance Issues

**Problem**: Slow extraction process

**Solution**:
1. Limit scan directories:
   ```javascript
   // Only scan necessary directories
   const TEMPLATES_DIR = path.join(__dirname, '../lib');
   ```

2. Use file filtering:
   ```javascript
   // Skip unnecessary files
   if (item.includes('.test.') || item.includes('.spec.')) {
     return; // Skip test files
   }
   ```

3. Implement caching:
   ```javascript
   // Cache results based on file modification time
   const cacheFile = path.join(__dirname, '../.cache/classes.json');
   ```

### Debugging

**Problem**: Need to debug extraction process

**Solution**:
1. Enable verbose logging:
   ```javascript
   const DEBUG = process.env.NODE_ENV === 'development';
   
   if (DEBUG) {
     console.log(`Scanning: ${filePath}`);
     console.log(`Found classes: ${extractedClasses.size}`);
   }
   ```

2. Output intermediate results:
   ```javascript
   // Save intermediate results for debugging
   fs.writeFileSync(
     'debug-classes.json',
     JSON.stringify(Array.from(extractedClasses), null, 2)
   );
   ```

## Best Practices

### Development Workflow

1. **Run extraction regularly**: Include in development scripts
2. **Version control**: Commit generated files or exclude them
3. **CI/CD integration**: Run extraction in build pipeline
4. **Testing**: Test extracted classes in production-like environment

### Template Design

1. **Consistent patterns**: Use consistent className patterns
2. **Avoid dynamic classes**: Minimize runtime class generation
3. **Documentation**: Document custom class patterns
4. **Validation**: Validate extracted classes

### Performance

1. **Incremental extraction**: Only re-extract changed files
2. **Caching**: Cache extraction results
3. **Parallel processing**: Process multiple files concurrently
4. **Optimization**: Remove duplicate classes efficiently

## Related Documentation

- [Template System Guide](./template-system-guide.md)
- [Build System Guide](./build-system-guide.md)
- [Performance Guide](./performance-guide.md)
- [Troubleshooting Guide](./troubleshooting-guide.md) 